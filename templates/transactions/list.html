{% extends "base.html" %}

{% block title %}Transactions - Self-Focus{% endblock %}

{% block content %}
<div class="d-flex justify-between align-center mb-4">
    <div>
        <h1 class="text-2xl font-bold">Financial Transactions</h1>
        <p class="text-gray-600">Track your income and expenses</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('transactions.create_transaction') }}" class="btn btn-primary">+ Add Transaction</a>
        <a href="{{ url_for('transactions.summary') }}" class="btn btn-outline">View Summary</a>
    </div>
</div>

<!-- Filter Bar -->
<div class="card mb-4">
    <form method="GET" class="d-flex gap-3 align-center">
        <div>
            <label class="form-label" for="type">Type:</label>
            <select name="type" id="type" class="form-control form-select">
                <option value="all" {{ 'selected' if type_filter == 'all' else '' }}>All</option>
                <option value="Income" {{ 'selected' if type_filter == 'Income' else '' }}>Income</option>
                <option value="Expense" {{ 'selected' if type_filter == 'Expense' else '' }}>Expense</option>
            </select>
        </div>
        
        <div>
            <label class="form-label" for="category">Category:</label>
            <select name="category" id="category" class="form-control form-select">
                <option value="all" {{ 'selected' if category_filter == 'all' else '' }}>All Categories</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {{ 'selected' if category_filter == category.id else '' }}>
                    {{ category.icon }} {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div>
            <button type="submit" class="btn btn-outline" style="margin-top: 1.5rem;">Filter</button>
        </div>
    </form>
</div>

<!-- Current Balance -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">Account Balance</h3>
    </div>
    <div style="text-align: center; padding: 2rem;">
        <div style="font-size: 2.5rem; font-weight: bold; color: {{ '#10b981' if current_user.get_balance() >= 0 else '#ef4444' }};">
            ${{ "%.2f"|format(current_user.get_balance()) }}
        </div>
        <p class="text-gray-600">Current balance</p>
    </div>
</div>

<!-- Transactions List -->
{% if transactions.items %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions.items %}
                <tr>
                    <td>{{ transaction.transaction_date.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <strong>{{ transaction.description or 'No description' }}</strong>
                    </td>
                    <td>
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            <span>{{ transaction.category.icon }}</span>
                            {{ transaction.category.name }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{{ 'success' if transaction.type.value == 'Income' else 'danger' }}">
                            {{ transaction.type.value }}
                        </span>
                    </td>
                    <td style="font-weight: 600; color: {{ '#10b981' if transaction.type.value == 'Income' else '#ef4444' }};">
                        {{ '+' if transaction.type.value == 'Income' else '-' }}${{ "%.2f"|format(transaction.amount) }}
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('transactions.edit_transaction', id=transaction.id) }}" class="btn btn-outline btn-sm">Edit</a>
                            <button onclick="deleteTransaction('{{ transaction.id }}', this)" class="btn btn-danger btn-sm">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if transactions.pages > 1 %}
    <div style="text-align: center; margin-top: 2rem;">
        <div class="d-flex justify-center gap-2">
            {% if transactions.has_prev %}
                <a href="{{ url_for('transactions.list_transactions', page=transactions.prev_num, type=type_filter, category=category_filter) }}" class="btn btn-outline btn-sm">Previous</a>
            {% endif %}
            
            <span class="btn btn-outline btn-sm" style="pointer-events: none;">
                Page {{ transactions.page }} of {{ transactions.pages }}
            </span>
            
            {% if transactions.has_next %}
                <a href="{{ url_for('transactions.list_transactions', page=transactions.next_num, type=type_filter, category=category_filter) }}" class="btn btn-outline btn-sm">Next</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

{% else %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.6;">ðŸ’°</div>
        <h3 class="text-xl mb-2">No transactions found</h3>
        <p class="text-gray-600 mb-4">Start tracking your finances by adding your first transaction!</p>
        <a href="{{ url_for('transactions.create_transaction') }}" class="btn btn-primary">Add Your First Transaction</a>
    </div>
{% endif %}

<script>
async function deleteTransaction(transactionId, button) {
    if (!confirm('Are you sure you want to delete this transaction?')) {
        return;
    }
    
    try {
        SelfFocus.setLoading(button, true);
        
        const response = await fetch(`/transactions/${transactionId}/delete`, {
            method: 'POST'
        });
        
        if (response.ok) {
            SelfFocus.showAlert('success', 'Transaction deleted successfully');
            location.reload(); // Refresh the page to show updated list
        } else {
            throw new Error('Failed to delete transaction');
        }
    } catch (error) {
        SelfFocus.showAlert('error', error.message || 'Failed to delete transaction');
    } finally {
        SelfFocus.setLoading(button, false);
    }
}
</script>
{% endblock %}